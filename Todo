import static org.mockito.Mockito.*;
import static org.junit.jupiter.api.Assertions.*;

import javax.persistence.EntityManager;
import javax.persistence.TypedQuery;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;
import org.mockito.junit.jupiter.MockitoExtension;

@ExtendWith(MockitoExtension.class)
class CoffreUtilServiceTest {

    @Mock
    private EntityManager entityManager;

    @Mock
    private User user;  // Mock the User object

    @InjectMocks
    private CoffreUtilService coffreUtilService;  // Automatically injects mocks

    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);
        // Mock the user object behavior to avoid NullPointerException
        when(user.getBmdRold()).thenReturn("mockRole");
    }

    @Test
    void testLoadCoffreData_Success() {
        // Arrange
        CriteriaBuilder cb = mock(CriteriaBuilder.class);
        CriteriaQuery<CoffreData> cq = mock(CriteriaQuery.class);
        Root<CoffreData> root = mock(Root.class);
        TypedQuery<CoffreData> typedQuery = mock(TypedQuery.class);

        when(entityManager.getCriteriaBuilder()).thenReturn(cb);
        when(cb.createQuery(CoffreData.class)).thenReturn(cq);
        when(cq.from(CoffreData.class)).thenReturn(root);

        Predicate predicate = mock(Predicate.class);
        when(cb.equal(root.get("id"), 1L)).thenReturn(predicate);
        when(cq.select(root)).thenReturn(cq);
        when(cq.where(predicate)).thenReturn(cq);

        when(entityManager.createQuery(cq)).thenReturn(typedQuery);
        when(typedQuery.getSingleResult()).thenReturn(mock(CoffreData.class));

        // Act
        CoffreData result = coffreUtilService.loadCoffreData(1L);

        // Assert
        assertNotNull(result);
        verify(entityManager, times(1)).createQuery(cq);
        verify(typedQuery, times(1)).getSingleResult();
        verify(user, times(1)).getBmdRold(); // Ensure the method was called on the mock
    }
}
